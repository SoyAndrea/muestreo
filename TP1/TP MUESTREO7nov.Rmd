---
title: "TP 1 - Muestreo"
author: "Gomez Vargas Andrea, Iummato Luciana, Pesce Andrea Gisele"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Ejercicio 1 


# Ejercio 2


# Ejercicios 3


```{r LIBRERIAS, message=FALSE, warning=FALSE}
library(readxl)
library(writexl)
library(ggplot2)
library(dplyr)
library(sampling)
library(survey)
```

```{r Armado de tablas}

# Lectura de las tablas
  radios_sexo <- read_excel("cen2010_radios_sexo.xlsx")
radios_tipo <- read_excel("cen2010_radios_tipo.xlsx")

# Juntamos los archivos para unificarlos en un unico dataframe
radios_2010 = merge(radios_sexo, radios_tipo, by = "Codigo")


# Generamos nuevas variables en el dataframe que utilizaremos mas adelante
# Juntamos los archivos para unificarlos en un unico dataframe
radios_2010 = merge(radios_sexo, radios_tipo, by = "Codigo")

# Generamos nuevas variables en el dataframe que utilizaremos mas adelante

# Poblacion total en cada radio
radios_2010$Pob_radio <- radios_2010$Varon + radios_2010$Mujer 

# Cantidad de viviendas en cada radio
radios_2010$Viv_radio <-  radios_2010$Casa + 
  radios_2010$Rancho + 
  radios_2010$Casilla + 
  radios_2010$Departamento + 
  radios_2010$Inquilinato + 
  radios_2010$Hotel_pension

# Extraemos el codigo de provincia
radios_2010$prov <- floor(radios_2010$Codigo/10000000)


# Creamos etiqueta para las provincias
radios_2010$Provincia <- "X"
radios_2010 <- radios_2010 %>%
  mutate(Provincia = case_when(prov == 2 ~ 'CABA', prov == 6 ~ 'BsAs',
                               prov == 10 ~ 'Catamarca', prov == 14 ~ 'Cordoba',
                               prov == 18 ~ 'Corrientes', prov == 22 ~ 'Chaco',
                               prov == 26 ~ 'Chubut', prov == 30 ~ 'Entre Rios',
                               prov == 34 ~ 'Formosa', prov == 38 ~ 'Jujuy',
                               prov == 42 ~ 'La Pampa', prov == 46 ~ 'La Rioja',
                               prov == 50 ~ 'Mendoza', prov == 54 ~ 'Misiones',
                               prov == 58 ~ 'Neuquen', prov == 62 ~ 'Rio Negro',
                               prov == 66 ~ 'Salta', prov == 70 ~ 'San Juan',
                               prov == 74 ~ 'San Luis', prov == 78 ~ 'Santa Cruz',
                               prov == 82 ~ 'Santa Fe', prov == 86 ~ 'Santiago',
                               prov == 90 ~ 'Tucuman', prov == 94 ~ 'TdFuego'))

print(radios_2010)
```

```{r Armado de tablas I }
# Eliminamos los radios sin viviendas
radios_2010 <- radios_2010[radios_2010$Viv_radio>0,]
N=nrow(radios_2010)
n=240

print(radios_2010)
```

## 1. Buscamos hallar los cuatro parámetros o valores poblacionales

```{r Parámetros}

poblacion<- sum(radios_2010$Pob_radio)
hogares_casa<-sum(radios_2010$Casa)
hogares_rancho<-sum(radios_2010$Rancho)+sum(radios_2010$Casilla)
prop_rancho<-(sum(radios_2010$Rancho)+sum(radios_2010$Casilla))/sum(radios_2010$Viv_radio)

print(poblacion)
print(hogares_casa)
print(hogares_rancho)
print(prop_rancho)
```

## 2. Calculamos la varianza para la estimacion del total:

```{r CV}


# En el MAS 
# Var(y_media) = (1-n/N)*S^2/n  
# Var(N*y_media) = N^2*(1-n/N)*S^2/n
P=prop_rancho
Q=1-prop_rancho
P+Q

S2_pob <- var(radios_2010$Pob_radio)
S2_casa <- var(radios_2010$Casa)
S2_rancho <- var(radios_2010$Rancho + radios_2010$Casilla)
S2_prop <- P*Q

VarMAS_MediaPob <- (1-n/N)*S2_pob/n
VarMAS_MediaCasa <- (1-n/N)*S2_casa/n
VarMAS_MediaRancho <- (1-n/N)*S2_rancho/n


VarMAS_pob <- N^2*VarMAS_MediaPob   #Recordar: Var(k*X)= k^2*Var(X)
VarMAS_casa <- N^2*VarMAS_MediaCasa 
VarMAS_rancho <- N^2*VarMAS_MediaRancho 


# Calculamos el coeficiente de variacion
CVMAS_Pob <- 100*sqrt(VarMAS_pob)/poblacion
CVMAS_Casa <- 100*sqrt(VarMAS_casa)/hogares_casa
CVMAS_Rancho <- 100*sqrt(VarMAS_rancho)/hogares_rancho

ds_prop<-sqrt(P*Q)
CVMAS_Prop <- 100 *(ds_prop/prop_rancho) #revisar

CVMAS_Pob
CVMAS_Casa
CVMAS_Rancho
CVMAS_Prop #revisar

```

> El CV de la estimación de rancho o casilla es grande porque el N del universo es menor que en el caso de la población general y los hogares tipo casa. El CV de la proporción de rancho o casilla es grande porque el valor de P es muy pequeño

```{r CV II}

#n=240*43

#para que el cv de la estimación de la población sea aproximadamente 2% n debe ser 1000
#para que el cv de la estimación de hogares tipo rancho o casilla sea aproximadamente 2% n debe ser 10000
```


```{r Muestra aleatoria simple}


# Seleccionamos ahora una muestra aleatoria simple con R
s_mas <- sample(N,n, replace=FALSE)

muestra_radios <- radios_2010[s_mas,]

#estimaciones muestrales N*y_media

muestra_poblac<-N*mean(muestra_radios$Pob_radio)
muestra_casa<-N*mean(muestra_radios$Casa)
muestra_rancho<-N*mean(muestra_radios$Rancho+muestra_radios$Casilla)
muestra_prop<-(sum(muestra_radios$Rancho)+sum(muestra_radios$Casilla))/sum(muestra_radios$Viv_radio)

# Agregamos al data frame el factor de expansion
# (recordar que seleccione una muestra aleatoria simple de radios)
muestra_radios$pondera <- N/n


# Cantidad total de unidades en el marco de muestreo
# lo necesitare luego para survey
muestra_radios$fpc <- N  

#junto rancho y casilla
muestra_radios$rancho_casilla <- muestra_radios$Rancho + muestra_radios$Casilla

# El objeto 'diseno' contiene toda la informacion que sera empleada para realizar las estimaciones.


diseno <- svydesign(id= ~1,weights=~pondera, data=muestra_radios, fpc=~fpc)
diseno
# (como es una muestra aleatoria simple ponemos fpc)

# Por ejemplo, si queremos extraer los pesos de un diseno podemos utilizar
pesos <- weights(diseno)


# total población
EstTotalPob <- survey :: svytotal(~Pob_radio, diseno, deff=TRUE, cv=TRUE, ci=TRUE)
EstTotalPob

# Puedo ahora extraer diferentes valores:
survey :: cv(EstTotalPob)      # -> coeficiente de variacion
deff(EstTotalPob)    # -> efecto de diseno
SE(EstTotalPob)      # -> desvio estandar
confint(EstTotalPob) # -> intervalor de confianza (por defecto 95%)
cv(EstTotalPob)

# O pasar los resultados a un data frame
df_EstTotalPob <- as.data.frame(EstTotalPob)

# Quiero cambiar el nombre de las columnas
colnames(df_EstTotalPob) <- c("Estimacion", "SE", "deff")

```


# Calculemos ahora el intervalo de confianza con un 90% de confianza
# (suponemos que el estimador es aprox normal)

```{r Intervalos de confianza}
df_EstTotalPob$Li <- df_EstTotalPob$Estimacion-1.64*df_EstTotalPob$SE  
df_EstTotalPob$Ls <- df_EstTotalPob$Estimacion+1.64*df_EstTotalPob$SE  


# Ahora calculo el CV del estimador
df_EstTotalPob$CV <-  100*df_EstTotalPob$SE/df_EstTotalPob$Estimacion


# total casas
EstTotalcasa <- survey::svytotal(~Casa, diseno, deff=TRUE, cv=TRUE, ci=TRUE)
EstTotalcasa

# Puedo ahora extraer diferentes valores:
survey ::cv(EstTotalcasa)      # -> coeficiente de variacion
deff(EstTotalcasa)    # -> efecto de diseno
SE(EstTotalcasa)      # -> desvio estandar
confint(EstTotalcasa) # -> intervalor de confianza (por defecto 95%)
cv(EstTotalcasa)

# O pasar los resultados a un data frame
df_EstTotalcasa <- as.data.frame(EstTotalcasa)

# Quiero cambiar el nombre de las columnas
colnames(df_EstTotalcasa) <- c("Estimacion", "SE", "deff")

# Calculemos ahora el intervalo de confianza con un 90% de confianza
# (suponemos que el estimador es aprox normal)
df_EstTotalcasa$Li <- df_EstTotalcasa$Estimacion-1.64*df_EstTotalPob$SE  
df_EstTotalcasa$Ls <- df_EstTotalcasa$Estimacion+1.64*df_EstTotalPob$SE  


# Ahora calculo el CV del estimador
df_EstTotalcasa$CV <-  100*df_EstTotalcasa$SE/df_EstTotalPob$Estimacion



# total rancho y casilla
EstTotalrancho <- survey :: svytotal(~rancho_casilla, diseno, deff=TRUE, cv=TRUE, ci=TRUE)
EstTotalrancho

# Puedo ahora extraer diferentes valores:
survey::cv(EstTotalrancho)      # -> coeficiente de variacion
deff(EstTotalrancho)    # -> efecto de diseno
SE(EstTotalrancho)      # -> desvio estandar
confint(EstTotalrancho) # -> intervalor de confianza (por defecto 95%)
cv(EstTotalrancho)

# O pasar los resultados a un data frame
df_EstTotalrancho <- as.data.frame(EstTotalrancho)

# Quiero cambiar el nombre de las columnas
colnames(df_EstTotalrancho) <- c("Estimacion", "SE", "deff")

# Calculemos ahora el intervalo de confianza con un 90% de confianza
# (suponemos que el estimador es aprox normal)
df_EstTotalrancho$Li <- df_EstTotalrancho$Estimacion-1.64*df_EstTotalPob$SE  
df_EstTotalrancho$Ls <- df_EstTotalrancho$Estimacion+1.64*df_EstTotalPob$SE  


# Ahora calculo el CV del estimador
df_EstTotalrancho$CV <-  100*df_EstTotalrancho$SE/df_EstTotalrancho$Estimacion


# proporcion
Estproporcion <- survey::svyratio(~rancho_casilla,~Viv_radio,  design = diseno, deff = TRUE, cv = TRUE, ci = TRUE)

Estproporcion

# Puedo ahora extraer diferentes valores:
estimador <- coef(Estproporcion)  # Estimador de la proporción
error_estandar <- SE(Estproporcion)  # Error estándar
cv1 <- cv(Estproporcion)  # Coeficiente de variación
intervalo_confianza <- confint(Estproporcion)  # Intervalo de confianza

#IC 90%

IC90Li <- estimador-1.64*error_estandar
IC90Ls <- estimador+1.64*error_estandar


# Ahora calculo el CV del estimador
CV_e <-  100*error_estandar/estimador

```




# EJERCICIO 4 

## Estimación, encuestando en su totalidad una Muestra Sistemática de n=240 radios censales para Total de población, Total de hogares que habitan en viviendas tipo Casa y Total de hogares que habitan en viviendas rancho/ casilla

### Estimación para Población

```{r Armo Tabla E4}

#Creo una nueva tabla para este ejercicio con la base que ya armamos en el Ejercicio 3.

radios_2010E4 <- radios_2010

N <- nrow(radios_2010E4)

# Tamano de la muestra
n <- 240

# Intervalo de selección
I <- floor(N/n)
print(I)

# Parametro poblacional
ParametroPobE4 <- sum(radios_2010E4$Pob_radio)
print(ParametroPobE4)

# Ordenamiento del marco de muestreo
radios_2010E4 <- radios_2010E4[order(radios_2010E4$Codigo),]
radios_2010E4$aleatorio <- runif(nrow(radios_2010E4),0,1)
radios_2010E4 <- radios_2010E4[order(radios_2010E4$Viv_radio),]
radios_2010E4 <- radios_2010E4[order(radios_2010E4$Pob_radio),]
radios_2010E4 <- radios_2010E4[order(radios_2010E4$aleatorio),]

```


```{r Arranque aleatorio}

# Definiremos el arranque aleatorio, generando un número aleatorio entre 1 y el intervalo de selección I, que en nuestro caso es 218. 


#aa <- sample(1:I, 1)
aa = 75
print(aa)

#El resultado de aa es 75. Le pondremos un # a la función dado que cada vez que se ejecuta cambiará el valor de aa

```


```{r Seleccion sistemática}

#Seleccionaremos una muestra sistemática de los datos en radios_2010E4 utilizando el arranque aleatorio aa = 75


s = radios_2010E4[ seq(aa,N,I), ]

``` 


Calcularemos una estimación del total poblacional y su error relativo para evaluar la precisión de la muestra sistemática.


```{r Precisión}

#Primero realizaremos la estimación del total poblacional usando el método de Horvitz-Thompson, un estimador insesgado en muestreo sistemático.

estim <- I*sum(s$Pob_radio)
print(estim)

error_rel <- 100*(ParametroPobE4 - estim) /ParametroPobE4
print(error_rel)

```

La estimación de la población usando una muestra de 240 radios censales es muy cercana al parámetro poblacional ParametroPobE4 (40115211), lo cual sugiere que la muestra debería ser buena.El error relativo es muy bajo, por lo que la muestra puede proveer una estimación precisa.


### Estimación para viviendas tipo Casa

```{r Casa}

#Parámetro poblacional para viviendas tipo Casa:
ParametroCasaE4 <- sum(radios_2010E4$Casa)  
print(ParametroCasaE4)

#Estimación para la muestra:
estimCasaE4 <- I * sum(s$Casa)  
print(estimCasaE4)

#Error relativo
error_relCasaE4 <- 100 * (ParametroCasaE4 - estimCasaE4) / ParametroCasaE4
print(error_relCasaE4)

```

El valor de la estimación calculada a partir de la muestra se aproxima bastante al valor real de la población, por lo cual el muestreo es representativo y el tamaño de la muestra se puede interpretar como adecuado.
El error relativo es muy bajo, por lo que la estimación es bastante cercana al parámetro poblacional real.


### Estimación para viviendas tipo Rancho o Casilla


```{r RanchoCasilla}

# Crear la columna Rancho_Casilla
radios_2010E4$Rancho_Casilla <- radios_2010E4$Rancho + radios_2010E4$Casilla

# Seleccionar la muestra sistemática
s = radios_2010E4[seq(aa, N, I), ]

# Parámetro poblacional
ParametroRanchoCasillaE4 <- sum(radios_2010E4$Rancho_Casilla)
print(ParametroRanchoCasillaE4)

# Estimación para la muestra
estimRanchoCasillaE4 <- I * sum(s$Rancho_Casilla)
print(estimRanchoCasillaE4)

# Error relativo
error_relRanchoCasillaE4 <- 100 * (ParametroRanchoCasillaE4 - estimRanchoCasillaE4) / ParametroRanchoCasillaE4
print(error_relRanchoCasillaE4)

```


La estimación de 426408 es cercano al parametro 461725, lo cual indica que el muestreo sistemático es preciso para estimar el total de viviendas tipo rancho o casilla.El error relativo es muy bajo siendo un buen indicador de precisión en el muestreo


## Compararemos dos estrategias utilizando como estimador la media muestral

###1. Muestreo sistemático, ordenando la tabla por Provincia-Total de viviendas del radio

Primero indicamos aquí nuevamente los parámetros que obtuvimos en el punto anterior:

```{r parametros E4}

print(ParametroPobE4)
print(ParametroCasaE4)
print(ParametroRanchoCasillaE4)

```

Comenzamos con la estrategia 1 que implica Orden por "Provincia-Total de viviendas del radio"

```{r Estrategia1 E4}

# Ordenar por Provincia y Total de viviendas del radio
Estrategia1E4 <- radios_2010E4[order(radios_2010E4$Provincia, radios_2010E4$Viv_radio), ]

# Tamaño de la muestra y cálculo del intervalo
n <- 240
N <- nrow(Estrategia1E4)
I <- floor(N / n)
print(I)

# Arranque aleatorio
# aa <- sample(1:I, 1)
# La función arroja un aa de 191. Le colocamos # dado que sino arrojará un aa diferente en cada ejecución
aa = 191
print(aa)

# Selección sistemática
muestraE1 <- Estrategia1E4[seq(aa, N, by = I), ]

# Estimaciones para la muestra en Estrategia 1
estimPobE1 <- I * mean(muestraE1$Pob_radio)
estimCasaE1 <- I * mean(muestraE1$Casa)
estimRancho_CasillaE1 <- I * mean(muestraE1$Rancho + muestraE1$Casilla)

print(estimPobE1)
print(estimCasaE1)
print(estimRancho_CasillaE1)

```
Ahora revisamos el error relativo para Estrategia 1

```{r error relativo Estrategia1 E4}
error_relPobE1 <- 100 * abs(ParametroPobE4 - estimPobE1) / ParametroPobE4
error_relCasaE1 <- 100 * abs(ParametroCasaE4 - estimCasaE1) / ParametroCasaE4
error_relRancho_CasillaE1 <- 100 * abs(ParametroRanchoCasillaE4 - estimRancho_CasillaE1) / ParametroRanchoCasillaE4

print(error_relPobE1)
print(error_relCasaE1)
print(error_relRancho_CasillaE1)
```

Los errores relativos son muy altos (cercanos al 100%), lo que indica que la estimación está muy alejada del valor poblacional, pudiendo interpretar que el ordenamiento esté afectando la representatividad.


###2. Muestreo sistemático, ordenando la tabla por un número pseudo aleatorio

```{r Estrategia2 E4}

# Ordenar por el número aleatorio
Estrategia2E4 <- radios_2010E4 [order(radios_2010E4$aleatorio), ]

# Selección sistemática
muestraE2 <- Estrategia2E4 [seq(aa, N, by = I), ]

# Estimaciones para la muestra en Estrategia 2
estimPobE2 <- I * mean(muestraE2$Pob_radio)
estimCasaE2 <- I * mean(muestraE2$Casa)
estimRancho_CasillaE2 <- I * mean(muestraE2$Rancho + muestraE2$Casilla)

print(estimPobE2)
print(estimCasaE2)
print(estimRancho_CasillaE2)
```


```{r error relativo Estrategia 2 E4}

error_relPobE2 <- 100 * abs(ParametroPobE4 - estimPobE2) / ParametroPobE4
error_relCasaE2 <- 100 * abs(ParametroCasaE4 - estimCasaE2) / ParametroCasaE4
error_relRancho_CasillaE2 <- 100 * abs(ParametroRanchoCasillaE4 - estimRancho_CasillaE2) / ParametroRanchoCasillaE4

print(error_relPobE2)
print(error_relCasaE2)
print(error_relRancho_CasillaE2)

```

Al parecer ninguna de las estrategias estaría dando resultados dado que los errores relativos son muy altos. La estrategia de muestreo sistemático puede que no sea la más adecuada para este caso.


### Hallar CV, deff, sesgo relativo y EMC de cada estrategia, seleccionando todas las muestas posibles

Calcularemos las I estimaciones posibles, una para cada arranque aleatorio. Definiremos una funcion que seleccione una muestra sistematica, con el arranque aleatorio como variable independiente y devuelva la estimacion


```{r error relativo Estrategia2 E4}

#HASTA ACA LLEGUE!! ESTO LO PUSO EL PROFE EN EL SCRIPT

# 
# estim_sistematico <- function(aa) {
#   s = radios_2010E4[ seq(aa,N,I), ]
#   estim <- I*sum(s$Pob_radio)
#   return(c(estim))
# }
# 
# 
# # Ejemplo
# estimacion <- estim_sistematico(2)
# 
# 
# 
# # Calculamos las I estimaciones posibles
# lista_arranques <- 1:I
# 
# lista_estimaciones <- lapply(lista_arranques, estim_sistematico)
# 
# df_estim <- data.frame(matrix(unlist(lista_estimaciones),ncol=1, byrow=TRUE ) )
# 
# 
# colnames(df_estim) <- c("Estimacion")
# 
# Esperanza   <-  mean(df_estim$Estimacion)
# Sesgo    <- Esperanza - parametro
# Varianza <-  var(df_estim$Estimacion)*(N-1)/N
# DS       <- sqrt(Varianza)
# CV_2        <- 100*DS/parametro
# CV_2


```


